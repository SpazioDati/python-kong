machine:
    services:
        - docker
        - cassandra
    python:
        version: 2.7.6
    environment:
        PYKONG_TEST_API_URL: http://localhost:8001
        PIP_CACHE_DIR: ~/pip-cache
    post:
        - pyenv global pypy-2.4.0 2.6.8 2.7.9 3.3.3 3.4.2

dependencies:
    cache_directories:
        - "~/docker"
        - "~/pip-cache"
    pre:
        - pip install -U pip
    override:
        - pip install tox
        - docker info
        - if [[ -e ~/docker/kong.tar ]]; then docker load --input ~/docker/kong.tar; fi
        - docker pull dirkmoors/kong
        - mkdir -p ~/docker; docker save dirkmoors/kong > ~/docker/kong.tar

database:
    pre:
        - sudo bash -c "echo \"listen_address = '0.0.0.0'\" >> /etc/cassandra/cassandra.yaml"
        - sudo service cassandra restart
        - ./circle.cassandra.sh

test:
    pre:
        - >
            docker run -d
            -p 8000:8000
            -p 8001:8001
            --name kong
            dirkmoors/kong; sleep 5
    override:
        - tox
